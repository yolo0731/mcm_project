# 问题1 模块代码解析

本文针对 `src/问题1` 目录下的核心脚本进行逐文件解析，梳理整体运行流程、数据处理链路以及所用算法原理，便于在理解题目背景的前提下快速掌握代码结构并进行二次开发。

## 1. 任务概览

- **输入数据**：`data/processed/94feature.csv`（已经提炼好的 94 份源域样本特征表）及 `data/raw/源域数据集` 中的原始 CWRU 轴承振动 `.mat` 文件；样本清单来自 `data/processed/MAT数据详细清单.xlsx`。
- **目标**：复现 notebook 中的全部统计可视化与高级分析（含包络滑窗、特征重采样及 t-SNE 可视化），并通过参数调优提升同类样本聚集度（轮廓系数最终≈0.85）。
- **主要输出**：`figs/问题1` 目录下的各类统计图、`data/processed/问题1` 中的波形图及高级分析结果（平衡特征表、t-SNE 坐标等）。

整体运行流程由 `1.py` 统一调度：若本地已存在 94 特征表则直接加载，否则会调用 `data_processing.py` 重新扫描原始 `.mat` 文件、提取多域特征，再交给 `visualization.py` 完成常规图表绘制，并在 `advanced_analysis.py` 中执行滑窗 + t-SNE 的深入分析。

## 2. 入口脚本 `1.py`

`main()` 函数负责配置环境、串联各模块：

1. **构建配置字典**：解析项目根路径，优先读取 `src/config.py` 中的参数（采样率、滤波带宽、轴承几何等），并准备正则 `LABEL_RE` 解析文件名中故障类型、缺陷尺寸、负载等元信息。
2. **载入特征表**：调用 `data_processing.process_data(config, force_rebuild)`，若 `FORCE_REBUILD_FEATURES` 为 False 则直接读取 `data/processed/94feature.csv`，否则按 Excel 清单重新生成。
3. **常规可视化**：构造 `figs/问题1` 目录，依次调用 `visualization.py` 中的绘图函数；如果 `_load_waveform_samples` 能从特征表回溯到原始 `.mat` 文件，将额外生成 DE 波形对比图（保存至 `data/processed/问题1/signal_waveforms_comparison.png`）。
4. **高级分析**：将特征表、项目根路径与配置传给 `advanced_analysis.perform_advanced_analysis`，执行后续的滑窗抽样、特征选择、t-SNE 网格搜索及结果持久化。

## 3. 特征生成模块 `data_processing.py`

该模块封装了“读取清单 → 搜索 `.mat` → 预处理 → 多域特征 → 保存 CSV”的流程，核心步骤如下：

- `_ensure_absolute_file_paths`：确保缓存特征表中的 `file` 列指向真实绝对路径，方便后续重新加载原始信号。
- `process_data(config, force_rebuild)`：
  - 若 `SAVE_PATH` 已存在且未强制重建，直接读取并校准路径；否则根据 Excel 清单逐条处理。
  - 通过 `Path.rglob` 在 `config['ROOT']` 下查找 .mat 文件，调用 `scipy.io.loadmat` 载入各测点数据；利用 `feature_extraction.infer_fs_from_path` 猜测原始采样率。
  - 优先从 Excel 中的 `rpm`/`转速` 等字段取得转速；若缺失则扫描 .mat 内含 `rpm` 的变量。转速转换成 `fr_hz` 以供轴承特征频率计算。
  - 调用 `feature_extraction.preprocess_signal`：线性去趋势 → 巴特沃斯带通 → `resample_poly` 重采样到 32 kHz。
  - 按测点(DE/FE/BA)提取三类特征：时间域 (`time_features`)、频域 (`spectral_features`)、包络域 (`envelope_features`)；并配合 `envelope_spectrum + freq_aligned_indicators` 计算 BPFO、BPFI、FTF、BSF 等故障频率能量指标。
  - 将所有特征连同文件元数据写回 `data/processed/94feature.csv`（UTF-8 编码）。

## 4. 信号特征工具 `feature_extraction.py`

该文件提供数据处理与特征计算的底层函数：

- **信号预处理**：`preprocess_signal` 采用带通滤波去除低频漂移与高频噪声，并将不同采样率统一到 32 kHz，保证后续特征可比。
- **时间域特征**：均值、标准差、RMS、峭度、偏度、峰值以及峰值因子、脉冲因子、形状因子、间隙因子等反映冲击与能量的指标。
- **频域特征**：基于 FFT 计算主频、谱质心、谱熵、谱带宽；包络域通过 Hilbert 变换获取包络 RMS 与峭度。
- **轴承频率对齐**：借助 `bearing_freqs` 得到 BPFO/BPFI/BSF/FTF，对应函数 `freq_aligned_indicators` 在这些特征频率 ±2 Hz 范围内统计峰值、能量及倍频、边带能量，用来衡量故障共振是否出现。
- **滑窗 & 增强特征**：`sliding_window` 负责生成固定长度窗口；`extract_enhanced_features` 在高级分析阶段使用，额外返回包络统计和频域能量比，以便对短时窗口特征排序。

## 5. 可视化模块 `visualization.py`

包含 notebook 中所有统计图的脚本化版本：

- 采样率/数据长度直方图、样本分布柱状 + 饼图、各类波形对比、RMS vs. Kurtosis 散点等基础探索。
- `plot_feature_correlation_heatmap` 限定关键特征绘制上三角热力图。
- `plot_load_stratified_distribution` 组合柱状、散点、箱线，展示负载分层下 RMS、峭度与故障类型的关系。
- `plot_vibration_mean_comparison`, `plot_vibration_std_comparison`, `plot_vibration_amplitude_range` 将 DE/FE/BA 三测点的均值、标准差、振幅区间进行对比。
- 所有绘图函数均自动创建目标目录、保存高分辨率 PNG，颜色、标题与 notebook 对齐。

## 6. 高级分析 `advanced_analysis.py`

该文件实现了题目要求的“包络 + 滑窗 + t-SNE”增强版分析流程，关键环节包括：

### 6.1 平衡数据集构建
- 对每种故障类别（OR/IR/B/N）：
  - 读取特征表中记录的原始文件；按配置做 detrend、带通、重采样，从而与训练流程保持一致。
  - 计算包络信号，并以 4096 点窗口、1024 点步长滑窗。每个窗口同时保留原始信号与包络子序列。
  - 对每个窗口提取两组特征：
    1. `extract_enhanced_features` 生成的基础时频包络指标（重命名为 `raw_*`）。
    2. 包络统计 `_window_stats`（均值、标准差、RMS、峰值、峭度、偏度），以及与原始 RMS/峰值的比值，用于衡量包络能量增强程度。
    3. `_bearing_aligned_features`：针对每个窗口重新计算包络谱并对齐轴承特征频率，提炼倍频、边带能量等判据。
  - 根据包络峭度 `env_kurtosis` 对窗口排序，选取前 121 个作为“高冲击”样本；若不足则进行带微小噪声的复制以维持平衡。

### 6.2 特征筛选与缩放
- 将所有窗口特征合并成 `features_df`，用方差过滤去除常数列。
- 两级 `SelectKBest`（`f_classif` + `mutual_info_classif`）保留 60 个以内的判别特征，再用 `StandardScaler` 归一化。

### 6.3 低维嵌入与 t-SNE 网格搜索
- 先运行 PCA/LDA，之后对 LDA 嵌入和 QDA 概率输出各自做 t-SNE。
- `tsne_grid` 限定 4 组组合（不同 perplexity/学习率/度量/初始化/随机种子），显著缩短搜索时间。
- 逐一计算轮廓系数，记录每个视图的最佳结果，并在附加面板展示全局最高得分（最终达到 0.846）。
- 图标题、控制台日志均改为英文，符合最终报告格式。

### 6.4 结果持久化
- 将筛选后的特征矩阵与标签保存为 `data/processed/问题1/balanced_features.csv`，便于后续建模。
- 最佳 t-SNE 坐标及轮廓系数保存到 `tsne_results_balanced.csv`。
- `tsne_comparison_balanced.png` 展示各视图最佳嵌入；`tsne_best_result_balanced.png` 进一步放大最佳方案，并提供密度视图。

## 7. 运行流程总结

1. **执行入口**：在仓库根目录运行 `python src/问题1/1.py`。
2. **数据加载**：读取 `94feature.csv`，必要时回溯原始 `.mat` 修复路径。
3. **常规可视化**：`visualization.py` 产出统计图与波形图。
4. **高级分析**：`advanced_analysis.py` 进行包络滑窗 → 特征筛选 → LDA/QDA → t-SNE 网格搜索 → 结果保存。
5. **输出目录**：
   - `figs/问题1/`：全部 PNG 图（采样率、类别分布、相关热图、振动对比、t-SNE 等）。
   - `data/processed/问题1/`：`balanced_features.csv`、`tsne_results_balanced.csv` 以及波形对比图等中间产物。

## 8. 算法与工程要点

- **信号预处理**：使用带通 + 重采样确保不同采样率的原始信号在 32 kHz 基准下可比；Hilbert 包络用于放大冲击型故障特征。
- **窗口筛选策略**：包络峭度是衡量冲击程度的经典指标，通过排序选取可提升类间 separability，同时限制窗口数量（≤40/文件）以控制运行时间。
- **特征选择**：F-score + mutual information 的两级筛选兼顾线性可分性与非线性关联，减少冗余并稳定 LDA/QDA。
- **t-SNE 参数裁剪**：仅保留少量人工调优过的组合（含 cosine / euclidean 度量、不同初始化），在保证效果的同时把执行时间降至数分钟级；max_iter=2000 平衡收敛速度与质量。
- **聚类度量**：silhouette score 作为唯一指标，最终达到约 0.84，显著高于原 notebook 的 0.39 水平。

## 9. 建议与扩展

- 若需进一步提升速度，可增大滑窗步长（例如 2048）或缩短 `tsne_grid`；但需观察轮廓系数是否受影响。
- `balanced_features.csv` 可直接用于后续迁移学习或分类模型训练；配合 `tsne_results_balanced.csv` 可快速验证类间可分性。
- 若要完全自动化重建 94 特征，只需在 `src/config.py` 将 `FORCE_REBUILD_FEATURES=True` 后重跑入口脚本。

以上即“问题1”模块的完整代码解析与算法说明，涵盖了数据处理、可视化及高级分析的全部实现细节。
